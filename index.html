<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تخزين جُمل وتوليد QR لصفحة عرض</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body{font-family:system-ui,Arial;background:#eaf6ff;margin:0;padding:24px}
    .wrap{max-width:820px;margin:auto}
    h1{margin:0 0 16px}
    .card{background:#fff;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1}
    input,button{
      width:100%;padding:10px;border:1px solid #cfd8e3;border-radius:8px;font-size:14px
    }
    button{background:#008cff;color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:start}
    .muted{color:#6b7280;font-size:12px}
    #qrcode{display:flex;justify-content:center;margin-top:16px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>تخزين جُمل وتوليد QR يفتح صفحة عرض</h1>

  <div class="card">
    <h3>إضافة عنصر</h3>
    <div class="row">
      <input id="textInput" placeholder="اكتب الجملة المرتبطة" />
      <button id="addBtn">إضافة</button>
    </div>
    <div class="muted">يتم توليد رقم تسلسلي تلقائي لكل عنصر.</div>
  </div>

  <div class="card">
    <h3>العناصر المخزّنة</h3>
    <table>
      <thead><tr><th style="width:90px;">Seq</th><th>النص</th><th style="width:100px;">حذف</th></tr></thead>
      <tbody id="listBody"></tbody>
    </table>
    <div class="muted" id="emptyHint" style="display:none;">لا توجد بيانات بعد.</div>
  </div>

  <div class="card">
    <h3>توليد QR</h3>
    <div class="actions">
      <button id="genRandomBtn">QR عشوائي (يفتح صفحة العرض)</button>
      <button id="genDataUrlBtn" title="نسخة تجريبية قد لا تعمل على iPhone">QR باستخدام data: URL</button>
      <button id="downloadBtn">تحميل صورة QR</button>
    </div>
    <div id="qrcode"></div>
    <div class="muted">
      عدّلي رابط صفحة العرض في السطر داخل الكود: <code>const VIEWER_URL = '...'</code>
    </div>
  </div>
</div>

<script>
/* ========= 1) عدّلي هذا بالرابط النهائي لصفحة العرض ========= */
/* مثال GitHub Pages:
   https://YOUR_USERNAME.github.io/YOUR_REPO/viewer.html
*/
const VIEWER_URL = 'https://YOUR_USERNAME.github.io/YOUR_REPO/viewer.html';

/* ========= قاعدة البيانات المحلية (IndexedDB) ========= */
const DB_NAME = 'seqTextDB';
const STORE = 'notes';
let db;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath:'id', autoIncrement:true });
      }
    };
    req.onsuccess = ()=>{ db = req.result; resolve(); };
    req.onerror = ()=>reject(req.error);
  });
}
async function openDBIfNeeded(){ if(!db) await openDB(); }
async function getAll(){
  await openDBIfNeeded();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
async function addItem(text){
  await openDBIfNeeded();
  const all = await getAll();
  const seq = all.length ? Math.max(...all.map(x=>x.seq||0))+1 : 1;
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
    tx.objectStore(STORE).add({ seq, text, created_at:new Date().toISOString() });
  });
}
async function deleteItem(seq){
  await openDBIfNeeded();
  const all = await getAll();
  const item = all.find(x=>x.seq===seq);
  if(!item) return;
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
    tx.objectStore(STORE).delete(item.id);
  });
}

/* ========= واجهة المستخدم ========= */
const textInput = document.getElementById('textInput');
const addBtn = document.getElementById('addBtn');
const listBody = document.getElementById('listBody');
const emptyHint = document.getElementById('emptyHint');
const genRandomBtn = document.getElementById('genRandomBtn');
const genDataUrlBtn = document.getElementById('genDataUrlBtn');
const qrcodeDiv = document.getElementById('qrcode');
const downloadBtn = document.getElementById('downloadBtn');
let lastCanvas = null;

addBtn.onclick = async ()=>{
  const txt = textInput.value.trim();
  if(!txt){ alert('اكتب الجملة أولاً'); return; }
  await addItem(txt);
  textInput.value = '';
  renderList();
};

async function renderList(){
  const items = await getAll();
  listBody.innerHTML = '';
  if(!items.length){ emptyHint.style.display='block'; }
  else { emptyHint.style.display='none'; }
  for(const it of items.sort((a,b)=>a.seq-b.seq)){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.seq}</td>
      <td>${escapeHtml(it.text)}</td>
      <td><button data-del="${it.seq}">🗑 حذف</button></td>`;
    listBody.appendChild(tr);
  }
  listBody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const seq = Number(btn.getAttribute('data-del'));
      if(confirm('متأكد من الحذف؟')){ await deleteItem(seq); renderList(); }
    };
  });
}

function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* ========= توليد رابط viewer مع بيانات Base64 في الـhash ========= */
function makeViewerUrl(seq, text){
  const payload = JSON.stringify({ seq, text });
  const b64 = btoa(unescape(encodeURIComponent(payload))); // Base64 UTF-8
  return `${VIEWER_URL}#${b64}`;
}

/* ========= توليد QR عشوائي (يفتح صفحة العرض) ========= */
genRandomBtn.onclick = async ()=>{
  const items = await getAll();
  if(!items.length){ alert('لا توجد بيانات بعد.'); return; }
  const rnd = items[Math.floor(Math.random()*items.length)];
  const url = makeViewerUrl(rnd.seq, rnd.text);

  qrcodeDiv.innerHTML='';
  new QRCode(qrcodeDiv,{text:url,width:240,height:240});
  setTimeout(()=>{ lastCanvas = qrcodeDiv.querySelector('canvas'); },300);
};

/* ========= خيار تجريبي: data: URL (قد لا يعمل على iPhone) ========= */
genDataUrlBtn.onclick = async ()=>{
  const items = await getAll();
  if(!items.length){ alert('لا توجد بيانات بعد.'); return; }
  const rnd = items[Math.floor(Math.random()*items.length)];
  const html = `<!doctype html><meta charset="utf-8">
    <title>عرض الجملة</title>
    <style>body{font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f7fbff}
      .card{background:#fff;padding:24px 28px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);max-width:520px;text-align:center}
      .seq{color:#6b7280;margin:0 0 10px} .txt{font-size:22px;margin:0}
    </style>
    <div class="card">
      <h3 class="seq">Seq: ${rnd.seq}</h3>
      <p class="txt">${escapeHtml(rnd.text)}</p>
    </div>`;
  const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);

  qrcodeDiv.innerHTML='';
  new QRCode(qrcodeDiv,{text:dataUrl,width:240,height:240});
  setTimeout(()=>{ lastCanvas = qrcodeDiv.querySelector('canvas'); },300);
};

/* ========= تنزيل صورة QR ========= */
downloadBtn.onclick = ()=>{
  if(!lastCanvas){ alert('ولّدي QR أولاً'); return; }
  const a = document.createElement('a');
  a.href = lastCanvas.toDataURL('image/png');
  a.download = 'qr.png';
  a.click();
};

/* start */
renderList();
</script>
</body>
</html>
