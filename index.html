<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ®Ø²ÙŠÙ† Ø¬ÙÙ…Ù„ ÙˆØªÙˆÙ„ÙŠØ¯ QR Ù„ØµÙØ­Ø© Ø¹Ø±Ø¶</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body{font-family:system-ui,Arial;background:#eaf6ff;margin:0;padding:24px}
    .wrap{max-width:820px;margin:auto}
    h1{margin:0 0 16px}
    .card{background:#fff;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1}
    input,button{
      width:100%;padding:10px;border:1px solid #cfd8e3;border-radius:8px;font-size:14px
    }
    button{background:#008cff;color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:start}
    .muted{color:#6b7280;font-size:12px}
    #qrcode{display:flex;justify-content:center;margin-top:16px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ØªØ®Ø²ÙŠÙ† Ø¬ÙÙ…Ù„ ÙˆØªÙˆÙ„ÙŠØ¯ QR ÙŠÙØªØ­ ØµÙØ­Ø© Ø¹Ø±Ø¶</h1>

  <div class="card">
    <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</h3>
    <div class="row">
      <input id="textInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©" />
      <button id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <div class="muted">ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø¹Ù†ØµØ±.</div>
  </div>

  <div class="card">
    <h3>Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®Ø²Ù‘Ù†Ø©</h3>
    <table>
      <thead><tr><th style="width:90px;">Seq</th><th>Ø§Ù„Ù†Øµ</th><th style="width:100px;">Ø­Ø°Ù</th></tr></thead>
      <tbody id="listBody"></tbody>
    </table>
    <div class="muted" id="emptyHint" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
  </div>

  <div class="card">
    <h3>ØªÙˆÙ„ÙŠØ¯ QR</h3>
    <div class="actions">
      <button id="genRandomBtn">QR Ø¹Ø´ÙˆØ§Ø¦ÙŠ (ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶)</button>
      <button id="genDataUrlBtn" title="Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ iPhone">QR Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… data: URL</button>
      <button id="downloadBtn">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© QR</button>
    </div>
    <div id="qrcode"></div>
    <div class="muted">
      Ø¹Ø¯Ù‘Ù„ÙŠ Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯: <code>const VIEWER_URL = '...'</code>
    </div>
  </div>
</div>

<script>
/* ========= 1) Ø¹Ø¯Ù‘Ù„ÙŠ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ ========= */
/* Ù…Ø«Ø§Ù„ GitHub Pages:
   https://YOUR_USERNAME.github.io/YOUR_REPO/viewer.html
*/
const VIEWER_URL = 'https://YOUR_USERNAME.github.io/YOUR_REPO/viewer.html';

/* ========= Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (IndexedDB) ========= */
const DB_NAME = 'seqTextDB';
const STORE = 'notes';
let db;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, { keyPath:'id', autoIncrement:true });
      }
    };
    req.onsuccess = ()=>{ db = req.result; resolve(); };
    req.onerror = ()=>reject(req.error);
  });
}
async function openDBIfNeeded(){ if(!db) await openDB(); }
async function getAll(){
  await openDBIfNeeded();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readonly');
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
async function addItem(text){
  await openDBIfNeeded();
  const all = await getAll();
  const seq = all.length ? Math.max(...all.map(x=>x.seq||0))+1 : 1;
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
    tx.objectStore(STORE).add({ seq, text, created_at:new Date().toISOString() });
  });
}
async function deleteItem(seq){
  await openDBIfNeeded();
  const all = await getAll();
  const item = all.find(x=>x.seq===seq);
  if(!item) return;
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE,'readwrite');
    tx.oncomplete = ()=>res();
    tx.onerror = ()=>rej(tx.error);
    tx.objectStore(STORE).delete(item.id);
  });
}

/* ========= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ========= */
const textInput = document.getElementById('textInput');
const addBtn = document.getElementById('addBtn');
const listBody = document.getElementById('listBody');
const emptyHint = document.getElementById('emptyHint');
const genRandomBtn = document.getElementById('genRandomBtn');
const genDataUrlBtn = document.getElementById('genDataUrlBtn');
const qrcodeDiv = document.getElementById('qrcode');
const downloadBtn = document.getElementById('downloadBtn');
let lastCanvas = null;

addBtn.onclick = async ()=>{
  const txt = textInput.value.trim();
  if(!txt){ alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
  await addItem(txt);
  textInput.value = '';
  renderList();
};

async function renderList(){
  const items = await getAll();
  listBody.innerHTML = '';
  if(!items.length){ emptyHint.style.display='block'; }
  else { emptyHint.style.display='none'; }
  for(const it of items.sort((a,b)=>a.seq-b.seq)){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.seq}</td>
      <td>${escapeHtml(it.text)}</td>
      <td><button data-del="${it.seq}">ğŸ—‘ Ø­Ø°Ù</button></td>`;
    listBody.appendChild(tr);
  }
  listBody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const seq = Number(btn.getAttribute('data-del'));
      if(confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')){ await deleteItem(seq); renderList(); }
    };
  });
}

function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* ========= ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· viewer Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Base64 ÙÙŠ Ø§Ù„Ù€hash ========= */
function makeViewerUrl(seq, text){
  const payload = JSON.stringify({ seq, text });
  const b64 = btoa(unescape(encodeURIComponent(payload))); // Base64 UTF-8
  return `${VIEWER_URL}#${b64}`;
}

/* ========= ØªÙˆÙ„ÙŠØ¯ QR Ø¹Ø´ÙˆØ§Ø¦ÙŠ (ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶) ========= */
genRandomBtn.onclick = async ()=>{
  const items = await getAll();
  if(!items.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.'); return; }
  const rnd = items[Math.floor(Math.random()*items.length)];
  const url = makeViewerUrl(rnd.seq, rnd.text);

  qrcodeDiv.innerHTML='';
  new QRCode(qrcodeDiv,{text:url,width:240,height:240});
  setTimeout(()=>{ lastCanvas = qrcodeDiv.querySelector('canvas'); },300);
};

/* ========= Ø®ÙŠØ§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ: data: URL (Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ iPhone) ========= */
genDataUrlBtn.onclick = async ()=>{
  const items = await getAll();
  if(!items.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.'); return; }
  const rnd = items[Math.floor(Math.random()*items.length)];
  const html = `<!doctype html><meta charset="utf-8">
    <title>Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…Ù„Ø©</title>
    <style>body{font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f7fbff}
      .card{background:#fff;padding:24px 28px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);max-width:520px;text-align:center}
      .seq{color:#6b7280;margin:0 0 10px} .txt{font-size:22px;margin:0}
    </style>
    <div class="card">
      <h3 class="seq">Seq: ${rnd.seq}</h3>
      <p class="txt">${escapeHtml(rnd.text)}</p>
    </div>`;
  const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);

  qrcodeDiv.innerHTML='';
  new QRCode(qrcodeDiv,{text:dataUrl,width:240,height:240});
  setTimeout(()=>{ lastCanvas = qrcodeDiv.querySelector('canvas'); },300);
};

/* ========= ØªÙ†Ø²ÙŠÙ„ ØµÙˆØ±Ø© QR ========= */
downloadBtn.onclick = ()=>{
  if(!lastCanvas){ alert('ÙˆÙ„Ù‘Ø¯ÙŠ QR Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const a = document.createElement('a');
  a.href = lastCanvas.toDataURL('image/png');
  a.download = 'qr.png';
  a.click();
};

/* start */
renderList();
</script>
</body>
</html>
